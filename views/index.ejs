<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/png" href="/images/hotel-icon.png">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/leaflet.css">
</head>
<body class="d-flex flex-column vh-100 m-0 p-0">

    <div class="container-fluid d-flex flex-column vh-100 p-0">
      <h1 class="text-center text-white bg-dark py-2 mb-0">
        Bienvenido a MapasMoreno <br> 
        <span class="h3">¡Principales hoteles en Málaga! Añade, edita y elimina a tu gusto:<br></span>
    
        <!-- Grupo de botones alineado al centro -->
        <div class="btn-group mt-2" role="group" aria-label="Botones de acción">
            <button type="button" class="btn btn-success" id="btn-add">Añadir</button>
            <button type="button" class="btn btn-warning">Editar</button>
            <button type="button" class="btn btn-danger">Eliminar</button>            
        </div>
      </h1>
        <div id="map" class="flex-grow-1 m-0 p-0"></div> <!-- Mapa ocupará toda la pantalla -->

        <footer class="text-center text-white bg-dark py-2">
          Hecho por Carlos Moreno Ruiz 2º DAW
      </footer>

    </div>

    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/leaflet.js"></script>
    <script src="/js/sweetalert2.all.min.js"></script>
    
    <script>
        var map = L.map('map').setView([36.7213, -4.4217], 13);
    
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
    
        // Definir un icono personalizado
        var hotelIcon = L.icon({
            iconUrl: '/images/hotel-icon.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });
    
        fetch('/hoteles.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, { icon: hotelIcon });
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties) {
                            let popupContent = `
                                <div style="max-width: 250px; padding: 10px;">
                                    <h5 style="text-align: center; font-size: 16px; margin-bottom: 8px;"><b>${feature.properties.nombre}</b></h5>
                                    <a href="${feature.properties.imagen}" target="_blank">
                                        <img src="${feature.properties.imagen}" alt="${feature.properties.nombre}" 
                                            style="width: 100%; height: auto; max-width: 200px; border-radius: 5px; display: block; margin: 0 auto 10px;">
                                    </a>
                                    <p style="font-size: 14px; margin: 2px 0;"><b>Dirección:</b> ${feature.properties.direccion}</p>
                                    <p style="font-size: 14px; margin: 2px 0;"><b>Teléfono:</b> ${feature.properties.telefono}</p>
                                    <p style="font-size: 14px; margin: 2px 0;"><b>Categoría:</b> ${feature.properties.categoria}</p>
                                    <p style="font-size: 14px; margin: 2px 0;"><b>Precio medio:</b> ${feature.properties.precio_medio}</p>
                                    <p style="font-size: 13px; margin-top: 6px;"><b>Descripción:</b> ${feature.properties.descripcion}</p>
                                </div>
                            `;
                            layer.bindPopup(popupContent);
                        }
                    }
                }).addTo(map);
            })
            .catch(error => console.error('Error cargando el archivo GeoJSON:', error));
    
        // Variable global para almacenar las coordenadas seleccionadas
        let selectedCoordinates = null;
    
        // Evento para capturar clics en el mapa y abrir el formulario
        map.on('click', function(e) {
            selectedCoordinates = [e.latlng.lat, e.latlng.lng];
    
            Swal.fire({
                title: 'Añadir un nuevo hotel',
                html: `
                    <input type="text" id="hotel-nombre" class="swal2-input" placeholder="Nombre del hotel">
                    <input type="text" id="hotel-direccion" class="swal2-input" placeholder="Dirección">
                    <input type="text" id="hotel-telefono" class="swal2-input" placeholder="Teléfono">
                    <select id="hotel-categoria" class="swal2-select">
                        <option value="" disabled selected>Seleccione una categoría</option>
                        <option value="1 estrella">1 estrella</option>
                        <option value="2 estrellas">2 estrellas</option>
                        <option value="3 estrellas">3 estrellas</option>
                        <option value="4 estrellas">4 estrellas</option>
                        <option value="5 estrellas">5 estrellas</option>
                    </select>
                    <input type="text" id="hotel-precio" class="swal2-input" placeholder="Precio medio (ej: 120€)">
                    <input type="text" id="hotel-imagen" class="swal2-input" placeholder="URL de la imagen">
                    <textarea id="hotel-descripcion" class="swal2-textarea" placeholder="Descripción del hotel" style="resize: none;"></textarea>
                    <p>Coordenadas seleccionadas: <b>${selectedCoordinates[0]}, ${selectedCoordinates[1]}</b></p>
                `,
                showCancelButton: true,
                confirmButtonText: 'Añadir',
                preConfirm: () => {
                    let nombre = document.getElementById('hotel-nombre').value.trim();
                    let direccion = document.getElementById('hotel-direccion').value.trim();
                    let telefono = document.getElementById('hotel-telefono').value.trim();
                    let categoria = document.getElementById('hotel-categoria').value;
                    let precio = document.getElementById('hotel-precio').value.trim();
                    let imagen = document.getElementById('hotel-imagen').value.trim();
                    let descripcion = document.getElementById('hotel-descripcion').value.trim();
    
                    if (!nombre || !direccion || !telefono || !categoria || !precio || !imagen || !descripcion) {
                        Swal.showValidationMessage('Todos los campos son obligatorios.');
                        return false;
                    }
    
                    return { nombre, direccion, telefono, categoria, precio_medio: precio, imagen, descripcion, coordenadas: selectedCoordinates };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let newMarker = L.marker(result.value.coordenadas, { icon: hotelIcon }).addTo(map);
                    let popupContent = `
                        <div style="max-width: 250px; padding: 10px;">
                            <h5 style="text-align: center; font-size: 16px; margin-bottom: 8px;"><b>${result.value.nombre}</b></h5>
                            <a href="${result.value.imagen}" target="_blank">
                                <img src="${result.value.imagen}" alt="${result.value.nombre}" 
                                    style="width: 100%; height: auto; max-width: 200px; border-radius: 5px; display: block; margin: 0 auto 10px;">
                            </a>
                            <p style="font-size: 14px; margin: 2px 0;"><b>Dirección:</b> ${result.value.direccion}</p>
                            <p style="font-size: 14px; margin: 2px 0;"><b>Teléfono:</b> ${result.value.telefono}</p>
                            <p style="font-size: 14px; margin: 2px 0;"><b>Categoría:</b> ${result.value.categoria}</p>
                            <p style="font-size: 14px; margin: 2px 0;"><b>Precio medio:</b> ${result.value.precio_medio}</p>
                            <p style="font-size: 13px; margin-top: 6px;"><b>Descripción:</b> ${result.value.descripcion}</p>
                        </div>
                    `;
                    newMarker.bindPopup(popupContent);
    
                    let hotelesGuardados = JSON.parse(localStorage.getItem('hoteles')) || [];
                    hotelesGuardados.push(result.value);
                    localStorage.setItem('hoteles', JSON.stringify(hotelesGuardados));
    
                    Swal.fire('¡Añadido!', 'El hotel ha sido agregado correctamente.', 'success');
                }
            });
        });
    
        // Cargar los hoteles guardados en LocalStorage al iniciar
        window.onload = function() {
            let hotelesGuardados = JSON.parse(localStorage.getItem('hoteles')) || [];
            hotelesGuardados.forEach(hotel => {
                let marker = L.marker(hotel.coordenadas, { icon: hotelIcon }).addTo(map);
                marker.bindPopup(`
                    <div style="max-width: 250px; padding: 10px;">
                        <h5 style="text-align: center;"><b>${hotel.nombre}</b></h5>
                        <p><b>Descripción:</b> ${hotel.descripcion}</p>
                    </div>
                `);
            });
        };
    </script>
    
  

</body>
</html>
